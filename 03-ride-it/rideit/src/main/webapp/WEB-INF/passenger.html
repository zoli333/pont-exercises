<html>
<head>
	<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.18.0/axios.js"></script>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.js"></script>
	
</head>
<body>

<div id="app" class="container" style="margin-top: 50px; max-width:600px;">
	<div class="row col-md-12">
		<table class="table table-bordered center-box" v-for="(car,index) in allcars" style="width:800px;">
		 	<thead style="background-color: lightgrey">
		 		<tr>
					<th>Car Number</th>
					<th>Driver Name</th>
					<th>Departure Time</th>
					<th>Departure Place</th>
					<th>Email</th>
					<th>Max Places</th>
					<th>Free Places</th>
				</tr>
			</thead>
			<tbody>
				<tr>
					<td><b>{{index}}</b></td>
					<td>{{car.driverName}}</td>
					<td>{{car.departuretimestring}}</td>
					<td>{{car.departureplace}}</td>
					<td>{{car.driverEmailAddress}}</td>
					<td>{{car.maxplaces}}</td>
					<td>{{car.freeplaces}}</td>
				</tr>
			</tbody>
			<thead>
				<tr>
					<th colspan="3">Passenger Name And Email</th>
					<th colspan="2">Connection Time</th>
					<th colspan="2">Connection Place</th>
				</tr>
			<tbody>
				<tr v-for="(d,index) in car.membersnameandemail">
					<td colspan="3" class="text-center">{{d}}</td>
					<td colspan="2" class="text-center">{{car.membersconnectiontime[index]}}</td>
					<td colspan="2" class="text-center">{{car.membersconnectionplace[index]}}</td>
				</tr>
				<tr>
					<td colspan="7">
						<form class="formclass" v-on:submit.prevent>
							<div class="checkbox mb-3">
								<label>
						        	<input type="checkbox" id="checkbox" v-model="car.checked">Check this button for later/sooner connection time and place
						        </label>
						    </div>
						    <div>
						    	<p>(If you not, the driver's departure place and time will be defined as yours as well!!)</p>
						    </div>
						    <div v-if="car.checked==true" style="maring: 0; padding: 0">
								<div class="form-group">
			 					 	<input type="text" class="contime form-control"  v-model="car.connectiontime" placeholder="Enter Time (YYYY-MM-DD HH:MM:SS)">
								</div>
								
								<div class="form-group">
									<input type="text" class="conplace form-control" v-model="car.connectionplace" placeholder="Enter Place">
								</div>
							</div>
							
							<div class="col-md-12 text-center"> 
							    <button class="btn btn-primary btn-lg" style="width:250px;" v-bind:id="car.car_id" name="applybut"  v-on:click="postSubscription(car.connectiontime, car.connectionplace, $event)" type="submit">Apply</button>
							    <button class="btn btn-primary btn-lg" style="width:250px;" v-bind:id="car.car_id" name="removebut"  v-on:click="postRemove($event)" type="submit">Remove</button>  
							</div>
							
						</form>
					</td>
				</tr>
			</tbody>	
		</table>
	</div>
</div>
</body>


<script>
	var app = new Vue({
		el: '#app',
		data: {
			car_id: '', //car id from database, local reference to help
			allcars: [], //carlist from database
			freeplaces: {}, //number of freeplaces (added to allcars object on javascript side / locally)
			membersnameandemail: {}, //username and email to display (added to allcars object on javascript side / locally) 
			membersconnectiontime: {}, //members means member's connection time for a specific car (added to allcars object on javascript side / locally)
			membersconnectionplace: {}, //same here members==member's (on member) (added to allcars object on javascript side / locally)
			
			connectiontime: {}, //another variable for getting the connection time for a secific car, defined by the user
			connectionplace: {}, // the same, the connection place defined by the current user logged in
			checked: {} //if the user checked the checkbutton
			//these last 3 parameters are defined as a model (v-model) to get the defined data for a specific car. 
			//This prevents the following: 
			//  When (for example) a user clicks on a checkbutton, we dont want all checkbuttons to be marked, and for example
			// all connection time and/or place displayed in every table at the same time.
		},
		methods: {
			getAllCars: function() {
  				var self = this;
  				axios.get("/rideit/index/getallcar")
  					.then(function(response){
  						self.allcars = response.data;
  						console.log(self.allcars);
  						for(var i=0;i<self.allcars.length;i++){
  							self.allcars[i].connectiontime='';
  							self.allcars[i].connectionplace='';
  							self.allcars.departure = moment(self.allcars.departuretime,"YYYY-MM-DD HH:MM:SS");
  							var carmembers = self.allcars[i].members;
  							var carmemberstime = self.allcars[i].connectiontimestring;
  							var carmembersplace = self.allcars[i].connectionplacestring;
  							var numOfMembers = 0;
  							if(carmembers!=null){
  								var splittedMembers = carmembers.split(",").filter(member => member!="");
  								var splittedMembersTime = carmemberstime.split(",").filter(membertime => membertime!="");
  								var splittedMembersPlace = carmembersplace.split(",").filter(memberplace => memberplace!="");
  								numOfMembers = splittedMembers.length;
  								self.allcars[i].freeplaces = self.allcars[i].maxplaces - numOfMembers;
  								self.allcars[i].membersnameandemail = splittedMembers;
  								self.allcars[i].membersconnectiontime = splittedMembersTime;
  								self.allcars[i].membersconnectionplace = splittedMembersPlace;
  							} else {
  								self.allcars[i].freeplaces = self.allcars[i].maxplaces;
  							}
  							
  						} 
  						
  					});
  			},
  			postSubscription: function(inputconnectiontime, inputconnectionplace, event) {
  				console.log(inputconnectiontime+","+inputconnectionplace+","+event);
  				var self = this;
  				if ((inputconnectiontime !== undefined && !inputconnectiontime !== null) && (inputconnectionplace !== undefined && inputconnectionplace !== null)) {
  					self.connectiontime = inputconnectiontime;
  					self.connectionplace = inputconnectionplace;  					
  				}
  				self.car_id = event.target.id;
  				axios.post('/rideit/index/subscription',
  					{
  						car_id: self.car_id,
  						connectiontime: self.connectiontime,
  						connectionplace: self.connectionplace
  					},
					{ 'content-type': 'text/plain;charset=utf-8' })
					.then(function(response){
						self.checked='';
						window.location.href="/rideit/index";
					});
  						
  			},
  			postRemove: function(event) {
  				var self = this;
  				self.car_id=event.target.id;
  				console.log("remove query")
  				axios.post('/rideit/index/removesubscription',
  	  					{
  	  						car_id: self.car_id,
  	  					},
  						{ 'content-type': 'text/plain;charset=utf-8' })
  						.then(function(response){
  							self.checked='';
  							window.location.href="/rideit/index";			
  						});
  			}
  		
  		},
  		mounted: function() {
			document.getElementById('app').style.display = 'block';
		}, 
		created: function() {
			this.getAllCars();
		}
  		
  		
	});
</script>

</html>






		
