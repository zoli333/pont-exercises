<html>
<head>
	<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.18.0/axios.js"></script>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.js"></script>
	
	 <!-- <link rel="stylesheet" type="text/css" href="./resources/css/style.css"> -->
	
	

	
</head>
<body>

<div id="app" class="container" style="margin-top: 50px; max-width:600px;">
	<div class="row col-md-12">
		<table class="table table-bordered center-box" v-for="car in allcars" style="width:800px;">
		 	<thead style="background-color: lightgrey">
		 		<tr>
					<th>Car Number</th>
					<th>Driver Name</th>
					<th>Departure Time</th>
					<th>Departure Place</th>
					<th>Email</th>
					<th>Max Places</th>
					<th>Free Places</th>
				</tr>
			</thead>
			<tbody>
				<tr>
					<td><b>{{car.car_id}}</b></td>
					<td>{{car.driverName}}</td>
					<td>{{car.departuretimestring}}</td>
					<td>{{car.departureplace}}</td>
					<td>{{car.driverEmailAddress}}</td>
					<td>{{car.maxplaces}}</td>
					<td>{{car.freeplaces}}</td>
				</tr>
			</tbody>
			<thead>
				<tr>
					<th colspan="3">Passenger Name And Email</th>
					<th colspan="2">Connection Time</th>
					<th colspan="2">Connection Place</th>
				</tr>
			<tbody>
				<tr v-for="(d,index) in car.membersnameandemail">
					<td colspan="3" class="text-center">{{d}}</td>
					<td colspan="2" class="text-center">{{car.membersconnectiontime[index]}}</td>
					<td colspan="2" class="text-center">{{car.membersconnectionplace[index]}}</td>
				</tr>
				<tr>
					<td colspan="7">
						
						<form id="car.car_id" class="formclass" v-on:submit.prevent>
							
							<div class="checkbox mb-3">
								<label>
						        	<input type="checkbox" id="checkbox" v-model="car.checked">Check this button for later/sooner connection time and place
						        </label>
						    </div>
						    <div>
						    	<p>(If you not, the driver's departure place and time will be defined as yours as well!!)</p>
						    </div>
							<div v-if="checked==true" style="maring: 0; padding: 0">
								<div class="form-group">
			 					 	<input type="text" class="contime form-control" v-bind:id="car.car_id"  v-model="connectiontime" placeholder="Enter Time (YYYY-MM-DD HH:MM:SS)" required>
								</div>
								
								<div class="form-group">
									<input type="text" class="conplace form-control" v-bind:id="car.car_id" v-model="connectionplace" placeholder="Enter Place" required>
								</div>
							</div>
							<div class="col-md-12"> 
							    <button class="btn btn-primary btn-lg" style="width:250px;" v-bind:id="car.car_id" name="applybut" v-bind="{ch: checked}" v-on:click="postSubscription($event)" type="submit">Apply</button>
							</div>
							
					
						</form>
					</td>
				</tr>
			</tbody>	
		</table>
	</div>
</div>
</body>


<script>
	var app = new Vue({
		el: '#app',
		data: {
			car_id: '',
			allcars: [],
			freeplaces: {},
			membersnameandemail: {},
			membersconnectiontime: {},
			membersconnectionplace: {},
			connectiontime: '',
			connectionplace: '',
			checked: ''
		},
		methods: {
			getAllCars: function() {
  				var self = this;
  				axios.get("/rideit/index/getallcar")
  					.then(function(response){
  						self.allcars = response.data;
  						for(var i=0;i<self.allcars.length;i++){
  							self.allcars.departure = moment(self.allcars.departuretime,"YYYY-MM-DD HH:MM:SS");
  							var carmembers = self.allcars[i].members;
  							var carmemberstime = self.allcars[i].connectiontimestring;
  							var carmembersplace = self.allcars[i].connectionplacestring;
  							var numOfMembers = 0;
  							if(carmembers!=null){
  								var splittedMembers = carmembers.split(",").filter(member => member!="");
  								var splittedMembersTime = carmemberstime.split(",").filter(membertime => membertime!="");
  								var splittedMembersPlace = carmembersplace.split(",").filter(memberplace => memberplace!="");
  								numOfMembers = splittedMembers.length;
  								self.allcars[i].freeplaces = self.allcars[i].maxplaces - numOfMembers;
  								self.allcars[i].membersnameandemail = splittedMembers;
  								self.allcars[i].membersconnectiontime = splittedMembersTime;
  								self.allcars[i].membersconnectionplace = splittedMembersPlace;
  							} else {
  								self.allcars[i].freeplaces = self.allcars[i].maxplaces;
  							}
  							
  						} 
  						
  					});
  			},
  			postSubscription: function(event) {
  				//console.log(event.target.id)
  				//get clicked id
  				var self = this;
  				console.log(event);
  				console.log("button check: " + self.checked);
  				self.car_id = event.target.id;
  				if(event.target.attributes["ch"].value === undefined || event.target.attributes["ch"].value === null) {
  					self.checked='';
  				} else {
  					self.checked = event.target.attributes["ch"].value;	
  				}
  				//var parsedDate = moment(self.connectiontime,"YYYY-MM-DD HH:mm:ss");
  				axios.post('/rideit/index/subscription',
  					{
  						car_id: self.car_id,
  						checked: self.checked,
  						connectiontime: self.connectiontime,
  						connectionplace: self.connectionplace
  					},
					{ 'content-type': 'text/plain;charset=utf-8' })
					.then(function(response){
						self.checked='';
						//self.checked=false;
						//document.getElementById(self.car_id).style.display = 'none';
						//window.location.href="/rideit/index";
					});
  						
  			}
  		},
  		mounted: function() {
			document.getElementById('app').style.display = 'block';
		}, 
		created: function() {
			this.getAllCars();
		}
  		
  		
	});
	
/*
postNewCarData: function() {
	var self = this;
	axios.post('/rideit/index/registernewcar',
		{
			drivername: self.drivername,
		 	password: self.password,
			firstname: self.firstname,
			lastname: self.lastname,
			email: self.email,
			maxplaces: self.maxplaces,
			members: ''
		},
		{ 'content-type': 'text/plain;charset=utf-8' })
		.then(function(response){
			self.result = response;
				});
		},
*/

</script>

</html>






		