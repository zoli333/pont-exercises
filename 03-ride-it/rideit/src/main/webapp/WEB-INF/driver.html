<html>
<head>
	<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.18.0/axios.js"></script>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.js"></script>
	
</head>
<body>

<div id="app" class="container" style="margin-top: 50px; max-width:600px;">
	<div class="row col-md-12">
		<span v-if="showRegistrationForm">
			<form class="form-signin" v-on:submit.prevent>
				<div><p>Please Enter the new car's registration data necessary</p></div>
				<div class="form-group">
					<input type="text" class="form-control"  v-model="departuretime" placeholder="Enter Departure Time (YYYY-MM-DD HH:MM:SS)" required>
					<p v-if="newcarparseerror==true">Wrong format!</p>
					<p v-else=""></p>
					</span>
					
				</div>
				<div class="form-group">
					<input type="text" class="form-control" v-model="departureplace" placeholder="Enter Departure Place" required>
				</div>
				<div class="form-group">
					<input type="text" class="form-control" v-model="maxplaces" placeholder="Enter Max places" required>
				</div>
				
				<button class="btn btn-primary btn-lg" style="width:250px;" v-on:click="sendNewCarRegistration(departuretime, departureplace,maxplaces)" type="submit">Send</button>
				<button class="btn btn-primary btn-lg" style="width:250px;" v-on:click="showRegistrationForm=false" >Cancel</button>				
			</form>
		</span>
		<span v-else="">
			<button class="btn btn-primary btn-lg" style="width:250px;" v-on:click="showRegistrationForm = true">Register new car</button>
			<hr class="borderdiv">
		</span>
		<span v-if="numberOfRegisteredCars>0">
			<table class="table table-bordered center-box" v-for="(car,index) in allcars" style="width:800px;">
			 	<thead style="background-color: lightgrey">
			 		<tr>
						<th>Car Number</th>
						<th>Driver Name</th>
						<th>Departure Time</th>
						<th>Departure Place</th>
						<th>Email</th>
						<th>Max Places</th>
						<th>Free Places</th>
					</tr>
				</thead>
				<tbody>
					<tr>
						<td><b>{{index}}</b></td>
						<td>{{car.driverName}}</td>
						<td>{{car.departuretimestring}}</td>
						<td>{{car.departureplace}}</td>
						<td>{{car.driverEmailAddress}}</td>
						<td>{{car.maxplaces}}</td>
						<td>{{car.freeplaces}}</td>
					</tr>
				</tbody>
				<thead>
					<tr>
						<th colspan="3">Passenger Name And Email</th>
						<th colspan="2">Connection Time</th>
						<th colspan="2">Connection Place</th>
					</tr>
				<tbody>
					<tr v-for="(d,index) in car.membersnameandemail">
						<td colspan="3" class="text-center">{{d}}</td>
						<td colspan="2" class="text-center">{{car.membersconnectiontime[index]}}</td>
						<td colspan="2" class="text-center">{{car.membersconnectionplace[index]}}</td>
					</tr>
					<tr>
						<td colspan="7">
							<form class="formclass" v-on:submit.prevent>
								<div class="form-group">
									<input type="text" class="form-control"  v-model="car.inputdeparturetime" placeholder="Enter Departure Time (YYYY-MM-DD HH:MM:SS)" required>
									<p v-if="inputparserror==true">Wrong format!</p>
									<p v-else=""></p>
								</div>
								<div class="form-group">
									<input type="text" class="form-control" v-model="car.inputdepartureplace" placeholder="Enter Departure Place" required>
								</div>
								<div class="form-group">
									<input type="text" class="form-control" v-model="car.inputmaxplaces" placeholder="Enter Max places" required>
								</div>
								<div class="col-md-12 text-center"> 
								    <button class="btn btn-primary btn-lg" style="width:250px;" v-bind:id="car.car_id" name="applybut"  v-on:click="postSubscription(car.inputdeparturetime, car.inputdepartureplace, car.inputmaxplaces, $event)" type="submit">Apply as driver</button>							    
								</div>
							</form>
							
							<div class="col-md-12 text-center"> 
								<button class="btn btn-primary btn-lg" style="width:250px;" v-bind:id="car.car_id" name="removebut"  v-on:click="postRemove($event)" type="submit">Remove</button>
							</div>
							
						</td>
					</tr>
				</tbody>	
			</table>
		</span>
		<span v-else-if="numberOfRegisteredCars==0">There has been no cars registered yet!!!</span>
		<span v-else=""></span>
	</div>
</div>
</body>


<script>
	var app = new Vue({
		el: '#app',
		data: {
			car_id: '', //car id from database, local reference to help
			allcars: [], //carlist from database
			numberOfRegisteredCars: '', //number of cars registered into database
			freeplaces: {}, //number of freeplaces (added to allcars object on javascript side / locally)
			membersnameandemail: {}, //username and email to display (added to allcars object on javascript side / locally) 
			membersconnectiontime: {}, //members means member's connection time for a specific car (added to allcars object on javascript side / locally)
			membersconnectionplace: {}, //same here members==member's (on member) (added to allcars object on javascript side / locally)
			inputdeparturetime: {},
			inputdepartureplace: {},
			inputmaxplaces: {},
			
			inputparserror: false,
			newcarparseerror: false,
			parseerror: '',
			index: '',
			showRegistrationForm: false,
			departuretime: '', //another variable for getting the connection time for a secific car, defined by the user
			departureplace: '', // the same, the connection place defined by the current user logged in
			maxplaces: '',
			checked: {} //if the user checked the checkbutton
			//these last 3 parameters are defined as a model (v-model) to get the defined data for a specific car. 
			//This prevents the following: 
			//  When (for example) a user clicks on a checkbutton, we dont want all checkbuttons to be marked, and for example
			// all connection time and/or place displayed in every table at the same time.
		},
		methods: {
			getAllCars: function() {
  				var self = this;
  				axios.get("/rideit/driverPage/getallcar")
  					.then(function(response){
  						self.allcars = response.data;
  						self.numberOfRegisteredCars = response.data.length;
  						//self.numberOfRegisteredCars = self.allcars.length;
  						console.log("num of reg cars: "  + self.numberOfRegisteredCars);
  						if(self.numberOfRegisteredCars!=0) {
  							for(var i=0;i < self.numberOfRegisteredCars;i++){
  	  							//self.allcars[i].departuretime = moment(self.allcars[i].departuretime,"YYYY-MM-DD HH:MM:SS");
  	  							
  	  							var carmembers = self.allcars[i].members;
  	  							var carmemberstime = self.allcars[i].connectiontimestring;
  	  							var carmembersplace = self.allcars[i].connectionplacestring;
  	  							var numOfMembers = 0;
  	  							if(carmembers!=null){
  	  								var splittedMembers = carmembers.split(",").filter(member => member!="");
  	  								var splittedMembersTime = carmemberstime.split(",").filter(membertime => membertime!="");
  	  								var splittedMembersPlace = carmembersplace.split(",").filter(memberplace => memberplace!="");
  	  								numOfMembers = splittedMembers.length;
  	  								self.allcars[i].membersnameandemail = splittedMembers;
  	  								self.allcars[i].membersconnectiontime = splittedMembersTime;
  	  								self.allcars[i].membersconnectionplace = splittedMembersPlace;
  	  								if(self.allcars[i].maxplaces==0) {
  	  									self.allcars[i].departuretimestring='';
  	  									self.allcars[i].freeplaces = '';	
  	  								}else {
  	  									self.allcars[i].freeplaces = self.allcars[i].maxplaces - numOfMembers;
  	  								}
  	  								
  	  							}else {
  	  								self.allcars[i].freeplaces = self.allcars[i].maxplaces;
  	  							}
  	  							
  	  						}	
  						}
  						 
  						
  					});
  			},
  			postSubscription: function(inputdeparturetime, inputdepartureplace, inputmaxplaces, event) {
  				var self = this;
  				if ((inputdeparturetime !== undefined && inputdeparturetime !== null && inputdeparturetime !=="") && (inputdepartureplace !== undefined && inputdepartureplace !== null && inputdepartureplace!=="") &&
  						(inputmaxplaces !== undefined && inputmaxplaces !== null && inputmaxplaces !== "")) {
  					
  					self.car_id = event.target.id;
  	  				axios.post('/rideit/driverPage/subscription',
  	  					{
  	  						car_id: self.car_id,
  	  						departuretime: inputdeparturetime,
  	  						departureplace: inputdepartureplace,
  	  						maxplaces: inputmaxplaces
  	  					},
  						{ 'content-type': 'text/plain;charset=utf-8' })
  						.then(function(response){
  							self.checked='';
  							if(response.data=="parseerror"){
  								self.inputparserror=true;
  							}else{
  								self.inputparserror=false;
  								window.location.href="/rideit/driverPage";	
  							}
  							
  						});
  				}
  				
  						
  			},
  			postRemove: function(event) {
  				var self = this;
  				self.car_id=event.target.id;
  				console.log("remove query")
  				axios.post('/rideit/driverPage/removesubscription',
  	  					{
  	  						car_id: self.car_id,
  	  					},
  						{ 'content-type': 'text/plain;charset=utf-8' })
  						.then(function(response){
  							self.checked='';
  							window.location.href="/rideit/driverPage";			
  						});
  			},
  			sendNewCarRegistration: function(inputdeparturetime, inputdepartureplace, inputmaxplaces) {
  				var self = this;
  				if ((inputdeparturetime !== undefined && inputdeparturetime !== null && inputdeparturetime !== "") && (inputdepartureplace !== undefined && inputdepartureplace !== null && inputdepartureplace !== "") &&
  						(inputmaxplaces !== undefined && inputmaxplaces !== null && inputmaxplaces !== "")) {
  					self.departuretime = inputdeparturetime;
  					self.departureplace = inputdepartureplace;
  					self.maxplaces = inputmaxplaces;
  					axios.post('/rideit/driverPage/registernewcar',
  		  					{
  								departuretime:  self.departuretime,
  								departureplace: self.departureplace,
  								maxplaces: self.maxplaces
  		  					},
  							{ 'content-type': 'text/plain;charset=utf-8' })
  							.then(function(response){
  								console.log(response);
  								if(response.data == "parseerror") {
  									self.newcarparseerror=true;
  								}else {
  									self.newcarparseerror=false;
  									window.location.href="/rideit/driverPage";
  								}
  									
  									
  											
  							});	
  				}
  					
  				
  			}
  		
  		},
  		mounted: function() {
			document.getElementById('app').style.display = 'block';
		}, 
		created: function() {
			this.getAllCars();
			
		}
  		
  		
	});
</script>

</html>






		
